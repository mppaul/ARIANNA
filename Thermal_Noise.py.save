
# To run: python Thermal_Noise.py -f Calibrated Root file path -n Number of Channels

import uproot as up
import numpy as np
import matplotlib.pyplot as plt
from scipy.stats import norm
import matplotlib.mlab as mlab
from optparse import OptionParser

if __name__ == '__main__':
        parser = OptionParser()
        parser.add_option("-f", "--file", help = "File contaning calib tree")
        parser.add_option("-n", "--nChans", default = 4, help = "Number of DAq channels")
        (options, args) = parser.parse_args()

        infn = options.file
        nChans = int(options.nChans)

print "Initializing..."
Printvals = False 	# Print each channel's average sigma, VRMS and offset for the entire data set
makePlots = False 	# Make histogram plots of the noise voltage*
log = False 		# Plot histogram in log
TempPlots = False 	# Make Temperature Plots: 1) VRMS vs Temp 2) Temp vs Time**
FreqPlots = True

colors = ["#FF9900","#0066FF","#CC00CC","#339933","#fd5249","#00c7c1","#58008f","#5ca7ff"]

# Opening Root file using Uproot and extracting Force Trigger Data and putting into a Numpy array

file = up.open(infn)
print "File Opened..."
data = np.array(file['CalibTree']['AmpOutData.']['AmpOutData.fData'].array())
Temp = np.array(file['TemperatureTree']['Temperature.']['Temperature.fTemp'].array())
print "Data Loaded..."

# Removal of Stops from Data

stops = file['CalibTree']['RawData.']['RawData.fStop'].array()
data_ns = np.zeros((len(data),8,245))
for i in range(len(data)):
	for k in range(len(stops[i])):
		if stops[i][k] > 0:
			for j in range(8):
				sam = (k+1)*8
				stp = np.linspace(sam-9,sam+1,11)
				for l in range(11):
					if stp[l] < 0:
						stp[l] = stp[l]+256
					if stp[l] > 255:
						stp[l] = stp[l]-256

				data_ns[i][j] = np.delete(data[i][j],stp)
			break
data = np.zeros((len(data),8,245))
data = data_ns

freq_data = {}
freq = np.fft.rfftfreq(245,d=1e-9)/1e9
for i in range(8):
	freq_data[i] = np.zeros((len(data), 123))
for i in range(len(data)):
	for j in range(8):
		freq_data[j][i] = np.abs(np.fft.rfft(data[i][j]))
'''for i in range(8):
	plt.pcolormesh(np.arange(0,len(data)),freq, np.transpose(freq_data[i]))
	plt.xlabel("Event Number")
	plt.ylabel("Frequncy [GHz]")
	plt.ylim(0,0.5)
	plt.colorbar()
	plt.show()
'''
temp_freq, avg_freq = {}, {}
for i in range(8):
	temp_freq[i] = np.zeros((len(data)/10,123))
	for j in range(len(data)/10):
		temp_freq[i][j] = np.sum(freq_data[i][j*10:(j+1)*10], axis=0)/10
	avg_freq[i] = np.sum(freq_data[i], axis=0)/len(freq_data[i])

for i in range(nChans):
	plt.figure(300)
	plt.plot(freq[1:],avg_freq[i][1:])
plt.show()

step_temps = {}
step_temps["-20-15"], step_temps["-15-10"],step_temps["-10-5"],step_temps["-50"],step_temps["05"],step_temps["510"],step_temps["1015"],step_temps["1520"],

for i in range(len(Temp)):
	if Temp[i] > -20 and Temp[i] > -15:
		step_temps["20-15"] 
# Calculation of each channel's average sigma, VRMS, and offset for whole data set

if Printvals == True:
	print "Channel \#: sigma, offset, Vrms"
	for i in range(nChans):
		sigma = np.std(data[:,i,:].flatten())
		avg = np.average(data[:,i,:].flatten())
		vrms = np.sqrt(np.mean(data[:,i,:].flatten()**2))
		print "Channel " + str(i) + ": " + str(round(sigma,1)) + ", " + str(round(avg,1)) + ", " + str(round(vrms,1))

# Make the histogram plots of the thermal noise can save to file or show in terminal

if makePlots == True:
	print "Making Histograms..."
	for i in range(nChans):
        	f,ax = plt.subplots()
	 	(mu, sig) = norm.fit(data[:,i,:].flatten())
        	n, bins, patches = plt.hist(data[:,i,:].flatten(),np.arange(min(data[:,i,:].flatten()), max(data[:,i,:].flatten()), 1),normed =1,color=colors[i],label="Channel " +str(i))
        	y = mlab.normpdf(bins, mu, sig)
		l = plt.plot(bins,y,"b--", label="Fit to " + str(sig))
		plt.legend()
		plt.xlabel("Voltage (mV)")
		plt.title("Channel " + str(i) + ": Sigma " + str(round(sig,1)) + ", Mu " + str(round(mu,1)))
		if log == True:
			ax.set_yscale('log')
			plt.ylim(10e-7,10e-1)
		plt.savefig("Channel_" + str(i) + "COLD_FPN_COLD_DATA" + ".png")

	#plt.show()

# Plot the sig, vrms, and offset as a function of temperature and temperature as a function of time [NOT AUTOMATED]

if TempPlots == True:
	print "Making Temperature Plots..."
	temperature  = []
	sig, avg, vrms = {}, {}, {}
	for k in range(nChans):
		sig[k], avg[k], vrms[k] = [], [], []
	for j in range(len(data)/10):
		temperature.append(np.average(Temp[j*3:(j+1)*3].flatten()))
		for i in range(nChans):
			sig[i].append(np.std(data[j*10:(j+1)*10,i,:].flatten()))
                	avg[i].append(np.average(data[j*10:(j+1)*10,i,:].flatten()))
                	vrms[i].append(np.sqrt(np.mean(data[j*10:(j+1)*10,i,:].flatten()**2)))
	'''for i in range(nChans):
		plt.figure(1)
		plt.plot(temperature, avg[i], color=colors[i], label="Channel " +str(i))
		plt.title("Offset as a function of Temperature")
		plt.legend()
		plt.xlabel("Temperature [Celsius]")
		plt.ylabel("Voltage [mV]")
		plt.figure(2)
                plt.plot(temperature, sig[i], color=colors[i], label="Channel " +str(i))
		plt.title("Sigma as a function of Temperature")
                plt.legend()
                plt.xlabel("Temperature [Celsius]")
                plt.ylabel("Voltage [mV]")
		plt.figure(3)
                plt.plot(temperature, vrms[i], color=colors[i], label="Channel " +str(i))
		plt.title("Vrms as a function of Temperature")
                plt.legend()
                plt.xlabel("Temperature [Celsius]")
                plt.ylabel("Voltage [mV]")
	for i in range(nChans):
		plt.figure(i+4)
		plt.pcolormesh(temperature, freq, np.transpose(temp_freq[i]))
		plt.colorbar()
		plt.ylim(0,0.5)
		plt.ylabel("Frequency [GHz]")
		plt.title("Channel " + str(i))
		plt.xlabel("Temperature [Celsius]")
	sam = np.arange(0,820,1)
	dt = np.delete(sam, np.arange(0,820,10))/60.0
	plt.figure()
	plt.plot(dt,Temp)
	plt.title("Temperature vs Time")
        plt.legend()
        plt.ylabel("Temperature [Celsius]")
        plt.xlabel("Time [Hours]")'''
	plt.show()


#if FreqPlots == True:

'''
bins = np.linspace(-80,80,81)

File = np.genfromtxt(infn, delimiter=',')
list = []
for i in range(len(File)-2):
	list.append(File[i+2][1])
Ghz = []
for i in range((len(File) -2)/4):
	Ghz.append(File[i*4][1])

data = np.array(list)*1000
data_downsam = np.array(Ghz)*1000

plt.figure(1)
plt.hist(data, np.arange(min(data), max(data), 0.6), normed =1)
plt.legend()
plt.xlabel("Voltage (mV)")

plt.figure(2)
plt.hist(data_downsam, np.arange(min(data_downsam), max(data_downsam), 0.6), normed =1)
plt.legend()
plt.xlabel("Voltage (mV)")

sigma = np.std(data)
sigma_down = np.std(data_downsam)

avg = np.average(data)
avg_down = np.average(data_downsam)


print "4Ghz " + str(sigma) + ", " + str(avg)
print "1Ghz (time domain) " + str(sigma_down) + ", " + str(avg_down)
plt.show()

'''
